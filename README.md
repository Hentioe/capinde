# capinde

Capinde 是一个可独立部署的验证服务，提供统一的生成和验证接口。可高度定制生成结果和验证过程，并提供对输出资源的托管访问。

## 介绍

本项目是使用 Rust 实现的 Web 应用程序，大部分图像处理操作基于 ImageMagick 的功能。推荐用法：用户自己整理/部署图集资源，Capinde 会将这些图集资源加工成以「图像为主」的不同类型验证。除此之外，它也具备生成经典验证码的能力。

_Capinde 当前主要用于「交互受限」的环境中，例如 Telegram/Discord 机器人。_

### 网格图片

从图集中选择多张图片，合成一张网格图片。要求选中包含主题事物的全部编号：

![网格验证图片](outs/9365690a-e347-47d7-aae0-949c31a3511c.jpg)

题：选择包含「兔子」的图片编号：

```json
[
  [1, 3, 8],
  [5, 7, 1],
  [2, 9, 4],
  [6, 3, 8],
  [4, 2, 5],
  [7, 9, 1],
  [1, 6, 9],
  [9, 4, 2],
  [1, 5, 7]
]
```

答：`[1, 6, 9]`。

### 普通图片

从图集中选择一张图片，要求选择该图片的主题事物：

![普通图片验证](outs/1f47c7ed-ef4c-4fb0-baca-f883c58e0751.jpg)

题：选择图片中的事物：

```json
[
  {
    "zh-hans": "猫",
    "zh-hant": "貓",
    "en": "Cat"
  },
  {
    "zh-hans": "花",
    "zh-hant": "花",
    "en": "Flower"
  },
  {
    "zh-hans": "鸟",
    "zh-hant": "鳥",
    "en": "Bird"
  },
  {
    "zh-hans": "船",
    "zh-hant": "船",
    "en": "Boat"
  }
]
```

答：

```json
{
  "zh-hans": "花",
  "zh-hant": "花",
  "en": "Flower"
}
```

_包含任一语言回答即可。图片摘要永远不会重复，因为图片会因定制参数或随机像素重写而变化。_

### 经典验证码

除了利用图集资源生成，还提供一个高度可定制的传统验证码类型：

![经典验证码](outs/41ab5274-2665-4baf-af32-10ff8543ffbd.jpg)

题：输入图片中的验证码：

```json
[
  "4FyoE",
  "AFyuE",
  "4FxuE",
  "4PyuE",
  "4FyuF",
  "4Fyu3",
  "4FyuE",
  "4FyvE",
  "hFyuE",
  "4EyuE",
  "4FvuE"
]
```

_以上是近似候选项（可选）。_

答：`4FyuE`。

## 定制性

Capinde 有强大的定制性，允许自由控制生成结果和验证过程。例如：

- 是否包含候选项
- 候选项个数
- 网格图像的布局
- 正确选项个数
- 水印字体
- 单元格大小
- 验证码复杂度
- 等等

同时你可以控制验证过程是否忽略顺序、大小写无关等。

## 托管验证

Capinde 虽然在响应中包含了所有数据如唯一 ID、正确答案、候选项等。你可以在本地实现验证逻辑，如缓存 `unique_id` 和正确答案，然后和用户的输入做对比。但 Capinde 自身提供了验证接口，它在内部实现了高效的验证缓存和淘汰策略。同时允许一定程度控制验证的严谨度。

_你只需要将用户的输入丢给 Capinde 即可。_

## 托管访问

Capinde 在输出验证图片的同时，还提供对图片的托管访问。假设生成的验证响应是：

```json
{
  "working_mode": "hosted",
  "namespace": "my_app",
  "unique_id": "35f38a09-d848-40bf-a61e-82196227d153",
  "file_name": "40d77e77-8354-4c85-b35a-e10e6e4c4619.jpg"
}
```

通过 `http://localhost:8080/assets/my_app/40d77e77-8354-4c85-b35a-e10e6e4c4619.jpg` 即可访问图片。当然，这要求程序工作在托管（`hosted`）模式中。

当验证过期时，图片将自动删除。图片清理通过优先级队列实现，始终只有一个清理任务（而非大量定时回调），高效而低开销。
